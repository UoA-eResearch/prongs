name: Release on tag

on: workflow_call

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v6

      - name: "Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: "pyproject.toml"

      - name: Read version from pyproject
        id: version
        run: |
          python - <<'PY'
          import tomllib, pathlib
          data = tomllib.loads(pathlib.Path("pyproject.toml").read_text())
          print(f"::set-output name=value::{data['project']['version']}")
          PY

      - name: Extract changelog section
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.value }}"
          awk -v ver="$VERSION" '
            BEGIN {found=0}
            /^##[[:space:]]*v[0-9]/ {
              if(found) exit
              if ($0 ~ ver) {found=1; next}
            }
            found {print}
          ' CHANGELOG.md > /tmp/release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: /tmp/release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
